import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import os

def plot_and_save_volcano(df, x_col, y_col, title="Volcano Plot", output_path="results/volcano.png"):
    """
    Genera un Volcano Plot e lo salva come PNG.
    
    Args:
    - df: Il DataFrame con i dati.
    - x_col: Nome della colonna Log2 Fold Change.
    - y_col: Nome della colonna P-value (o adj. P-value).
    - title: Titolo del grafico.
    - output_path: Percorso dove salvare l'immagine.
    """
    
    # Crea una copia per non modificare il dataframe originale
    data = df.copy()
    
    # Calcola il -log10 del p-value se non esiste già
    # (Assumendo che y_col sia il p-value grezzo)
    data['-log10_pval'] = -np.log10(data[y_col])
    
    # Definisci i colori basati sulle soglie (es. p-value < 0.05 e FC > 1)
    # Nota: Modifica 1.3 (che è -log10(0.05)) e 1 (FC) secondo le tue esigenze
    conditions = [
        (data[x_col] >= 1) & (data['-log10_pval'] >= 1.3),  # UP (Rosso)
        (data[x_col] <= -1) & (data['-log10_pval'] >= 1.3), # DOWN (Blu)
    ]
    choices = ['Up-regulated', 'Down-regulated']
    data['category'] = np.select(conditions, choices, default='Not Significant')

    # Crea il plot
    plt.figure(figsize=(10, 6))
    sns.scatterplot(data=data, x=x_col, y='-log10_pval', hue='category', 
                    palette={'Up-regulated': 'red', 'Down-regulated': 'blue', 'Not Significant': 'lightgrey'},
                    alpha=0.7)
    
    # Aggiungi linee di soglia
    plt.axhline(y=1.3, color='black', linestyle='--', linewidth=1) # Soglia p-value 0.05
    plt.axvline(x=1, color='black', linestyle='--', linewidth=1)   # Soglia FC 1
    plt.axvline(x=-1, color='black', linestyle='--', linewidth=1)  # Soglia FC -1

    plt.title(title)
    plt.xlabel(f"{x_col} (Log2 Fold Change)")
    plt.ylabel("-Log10 P-value")
    plt.legend(title="Gene Status")
    

    os.makedirs(os.path.dirname(output_path), exist_ok=True)
    
    # Salva in alta risoluzione (dpi=300)
    plt.savefig(output_path, dpi=300, bbox_inches='tight')
    print(f"Grafico salvato correttamente in: {output_path}")
    
    plt.show()

